#cloud-config
write_files:
- path: /etc/slurm/oci.conf
  owner: root:root
  permissions: '0644'
  content: |
    EnvExclude="^(SLURM_CONF|SLURM_CONF_SERVER)="
    RunTimeEnvExclude="^(SLURM_CONF|SLURM_CONF_SERVER)="
    RunTimeQuery="sudo singularity oci state %n.%u.%j.%s.%t"
    RunTimeCreate="sudo singularity oci create --bundle %b %n.%u.%j.%s.%t"
    RunTimeStart="sudo singularity oci start %n.%u.%j.%s.%t"
    RunTimeKill="sudo singularity oci kill %n.%u.%j.%s.%t"
    RunTimeDelete="sudo singularity oci delete %n.%u.%j.%s.%t"

- path: /etc/slurm/slurm.conf
  owner: root:root
  permissions: '0644'
  content: |
    ClusterName=democluster

    SlurmUser=slurm
    SlurmdUser=root
    SlurmdPort=6818
    SlurmctldPort=6817
    SlurmctldHost=@HEADNODE_HOSTNAME@
    SlurmctldAddr=@HEADNODE_ADDRESS@

    AuthType=auth/munge
    AuthInfo="socket=/var/run/munge/munge.socket.2"

    SlurmctldPidFile=/var/run/slurmctld.pid
    SlurmdPidFile=/var/run/slurmd.pid

    SlurmctldLogFile=/var/log/slurm/slurmctld.log
    SlurmdLogFile=/var/log/slurm/slurmd.log

    SlurmdSpoolDir=/var/lib/slurm/slurmd
    StateSaveLocation=/var/lib/slurm/checkpoint

    PluginDir=/usr/lib/x86_64-linux-gnu/slurm-wlm/

    PlugStackConfig=/etc/slurm/plugstack.conf

    ProctrackType=proctrack/linuxproc

    ReturnToService=2
    RebootProgram="/usr/sbin/reboot --reboot"
    MailProg=/usr/bin/mail.mailutils

    # Timers
    SlurmctldTimeout=300
    SlurmdTimeout=60
    InactiveLimit=0
    MinJobAge=86400
    KillWait=30
    Waittime=0

    # Scheduling
    SchedulerType=sched/backfill
    SelectType=select/cons_tres
    SelectTypeParameters=CR_CPU_Memory

    # Logging
    SlurmctldDebug=3
    SlurmdDebug=3

    # Accounting
    AcctGatherProfileType=acct_gather_profile/influxdb
    AcctGatherNodeFreq=10
    JobAcctGatherType=jobacct_gather/linux
    JobAcctGatherFrequency="task=5"

    TaskPlugin="task/affinity"

    # Slurmdbd
    AccountingStorageType=accounting_storage/slurmdbd
    AccountingStorageHost=@HEADNODE_ADDRESS@
    AccountingStorageUser=slurm
    AccountingStoragePort=6839

    # Node Configurations
    NodeName=@HEADNODE_HOSTNAME@ NodeAddr=@HEADNODE_ADDRESS@ CPUs=@CPUs@ ThreadsPerCore=@THREADS_PER_CORE@ CoresPerSocket=@CORES_PER_SOCKET@ Sockets=@SOCKETS@ RealMemory=@REAL_MEMORY@

    # Partition Configurations
    PartitionName=compute Nodes=@HEADNODE_HOSTNAME@ MaxTime=INFINITE State=UP Default=Yes


- path: /etc/slurm/slurmdbd.conf
  owner: root:root
  permissions: '0600'
  content: |
    DbdHost=@HEADNODE_HOSTNAME@
    DbdPort=6839

    AuthType=auth/munge
    AuthInfo=socket=/var/run/munge/munge.socket.2

    SlurmUser=slurm

    PluginDir=/usr/lib/x86_64-linux-gnu/slurm-wlm/

    PidFile=/var/run/slurmdbd.pid

    LogFile=/var/log/slurm/slurmdbd.log

    StorageType=accounting_storage/mysql
    StorageHost=127.0.0.1
    StoragePort=3306
    StoragePass=rats
    StorageUser=slurm
    StorageLoc=slurm

    DebugLevel=info

- path: /etc/slurm/acct_gather.conf
  owner: root:root
  permissions: '0644'
  content: |
    ProfileInfluxDBDatabase=slurm-job-metrics
    ProfileInfluxDBDefault=All
    ProfileInfluxDBHost=localhost:8086
    ProfileInfluxDBPass=rats
    ProfileInfluxDBUser=slurm
    ProfileInfluxDBRTPolicy=three_days

users:
- name: root
  lock_passwd: false
  hashed_passwd: "$6$canonical.$0zWaW71A9ke9ASsaOcFTdQ2tx1gSmLxMPrsH0rF0Yb.2AEKNPV1lrF94n6YuPJmnUy2K2/JSDtxuiBDey6Lpa/"
  ssh_redirect_user: false
- default

system_info:
  default_user:
    name: ubuntu
    plain_text_passwd: 'ubuntu'
    home: /home/ubuntu
    shell: /bin/bash
    lock_passwd: false
    gecos: Ubuntu
    groups: [ adm, cdrom, dip, lxd, sudo ]
    sudo: [ "ALL=(ALL) NOPASSWD:ALL" ]
ssh_pwauth: True
disable_root: false
preserve_hostname: true
package_update: true

apt:
  sources:
    ubuntu-hpc:
        source: "deb https://ppa.launchpadcontent.net/ubuntu-hpc/experimental/ubuntu noble main"
        key: |
           -----BEGIN PGP PUBLIC KEY BLOCK-----
           Comment: Hostname:
           Version: Hockeypuck 2.2

           xsFNBGTuZb8BEACtJ1CnZe6/hv84DceHv+a54y3Pqq0gqED0xhTKnbj/E2ByJpmT
           NlDNkpeITwPAAN1e3824Me76Qn31RkogTMoPJ2o2XfG253RXd67MPxYhfKTJcnM3
           CEkmeI4u2Lynh3O6RQ08nAFS2AGTeFVFH2GPNWrfOsGZW03Jas85TZ0k7LXVHiBs
           W6qonbsFJhshvwC3SryG4XYT+z/+35x5fus4rPtMrrEOD65hij7EtQNaE8owuAju
           Kcd0m2b+crMXNcllWFWmYMV0VjksQvYD7jwGrWeKs+EeHgU8ZuqaIP4pYHvoQjag
           umqnH9Qsaq5NAXiuAIAGDIIV4RdAfQIR4opGaVgIFJdvoSwYe3oh2JlrLPBlyxyY
           dayDifd3X8jxq6/oAuyH1h5K/QLs46jLSR8fUbG98SCHlRmvozTuWGk+e07ALtGe
           sGv78ToHKwoM2buXaTTHMwYwu7Rx8LZ4bZPHdersN1VW/m9yn1n5hMzwbFKy2s6/
           D4Q2ZBsqlN+5aW2q0IUmO+m0GhcdaDv8U7RVto1cWWPr50HhiCi7Yvei1qZiD9jq
           57oYZVqTUNCTPxi6NeTOdEc+YqNynWNArx4PHh38LT0bqKtlZCGHNfoAJLPVYhbB
           b2AHj9edYtHU9AAFSIy+HstET6P0UDxy02IeyE2yxoUBqdlXyv6FL44E+wARAQAB
           zRxMYXVuY2hwYWQgUFBBIGZvciBVYnVudHUgSFBDwsGOBBMBCgA4FiEErocSHcPk
           oLD4H/Aj9tDF1ca+s3sFAmTuZb8CGwMFCwkIBwIGFQoJCAsCBBYCAwECHgECF4AA
           CgkQ9tDF1ca+s3sz3w//RNawsgydrutcbKf0yphDhzWS53wgfrs2KF1KgB0u/H+u
           6Kn2C6jrVM0vuY4NKpbEPCduOj21pTCepL6PoCLv++tICOLVok5wY7Zn3WQFq0js
           Iy1wO5t3kA1cTD/05v/qQVBGZ2j4DsJo33iMcQS5AjHvSr0nu7XSvDDEE3cQE55D
           87vL7lgGjuTOikPh5FpCoS1gpemBfwm2Lbm4P8vGOA4/witRjGgfC1fv1idUnZLM
           TbGrDlhVie8pX2kgB6yTYbJ3P3kpC1ZPpXSRWO/cQ8xoYpLBTXOOtqwZZUnxyzHh
           gM+hv42vPTOnCo+apD97/VArsp59pDqEVoAtMTk72fdBqR+BB77g2hBkKESgQIEq
           EiE1/TOISioMkE0AuUdaJ2ebyQXugSHHuBaqbEC47v8t5DVN5Qr9OriuzCuSDNFn
           6SBHpahN9ZNi9w0A/Yh1+lFfpkVw2t04Q2LNuupqOpW+h3/62AeUqjUIAIrmfeML
           IDRE2VdquYdIXKuhNvfpJYGdyvx/wAbiAeBWg0uPSepwTfTG59VPQmj0FtalkMnN
           ya2212K5q68O5eXOfCnGeMvqIXxqzpdukxSZnLkgk40uFJnJVESd/CxHquqHPUDE
           fy6i2AnB3kUI27D4HY2YSlXLSRbjiSxTfVwNCzDsIh7Czefsm6ITK2+cVWs0hNQ=
           =cs1s
           -----END PGP PUBLIC KEY BLOCK-----
    apptainer:
      source: "deb https://ppa.launchpadcontent.net/apptainer/ppa/ubuntu noble main"
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Comment: Hostname:
        Version: Hockeypuck 2.1.0-223-gdc2762b
    
        xsFNBGPKLe0BEADKAHtUqLFryPhZ3m6uwuIQvwUr4US17QggRrOaS+jAb6e0P8kN
        1clzJDuh3C6GnxEZKiTW3aZpcrW/n39qO263OMoUZhm1AliqiViJgthnqYGSbMgZ
        /OB6ToQeHydZ+MgI/jpdAyYSI4Tf4SVPRbOafLvnUW5g/vJLMzgTAxyyWEjvH9Lx
        yjOAXpxubz0Wu2xcoefN0mKCpaPsa9Y8xmog1lsylU+H/4BX6yAG7zt5hIvadc9Z
        Y/vkDLh8kNaEtkXmmnTqGOsLgH6Nc5dnslR6Gwq966EC2Jbw0WbE50pi4g21s6Wi
        wdU27/XprunXhhLdv6PYUaqdXxPRdBh+9u0LmNZsAyUxT6EgN05TAWFtaMOz7I3B
        V6IpHuLqmIcnqulHrLi+0D/aiCv53WEZrBRmDBGX7p52lcyS+Q+LFf0+iYeY7pRG
        fPXboBDr+6DelkYFIxam06purSGR3T9RJyrMP7qMWiInWxcxBoCMNfy8VudP0DAy
        r2yXmHZbgSGjfJey03dnNwQH7huBcQ1VLEqtL+bjn3HubmYK87FltX7xomETFqcl
        QmiT+WBttFRGtO6SFHHiBXOXUn0ihwabtr6gRKeJssCnFS3Y46RDv4z3Je92roLt
        TPY8F9CgZrGiAoKq530BzEhJB6vfW3faRnLKdLePX/LToCP0g2t2jKwkzQARAQAB
        zRtMYXVuY2hwYWQgUFBBIGZvciBBcHB0YWluZXLCwY4EEwEKADgWIQT2sPUZPU8z
        Ae9JH/Cv42U0/GIYrgUCY8ot7QIbAwULCQgHAgYVCgkICwIEFgIDAQIeAQIXgAAK
        CRCv42U0/GIYrut4EAC06vTJP2wgnh3BIZ3n2HKaSp4QsuYKS7F7UQJ5Yt+PpnKn
        Pgjq3R4fYzOHyASv+TCj9QkMaeqWGWb6Zw0n47EtrCW9U5099Vdk2L42KjrqZLiW
        qQ11hwWXUlc1ZYSOb0J4WTumgO6MrUCFkmNrbRE7yB42hxr/AU/XNM38YjN2NyOK
        2gvORRKFwlLKrjE+70HmoCW09Yk64BZl1eCubM/qy5tKzSlC910uz87FvZmrGKKF
        rXa2HGlO4O3Ty7bMSeRKl9m1OYuffAXNwp3/Vale9eDHOeq58nn7wU9pSosmqrXb
        SLOwqQylc1YoLZMj+Xjx644xm5e2bhyD00WiHeqHmvlfQQWCWaPt4i4K0nJuYXwm
        BCA6YUgSfDZJfg/FxJdU7ero5F9st2GK4WDBiz+1Eftw6Ik/WnMDSxXaZ8pwnd9N
        +aAEc/QKP5e8kjxJMC9kfvXGUVzZuMbkUV+PycZhUWl4Aelua91lnTicVYfpuVCC
        GqY0StWQeOxLJneI+1FqLFoBOZghzoTY5AYCp99RjKqQvY1vF4uErltmNeN1vtBm
        CZyDOLQuQfqWWAunUwXVuxMJIENSVeLXunhu9ac24Vnf2rFqH4XVMDxiKc6+sv+v
        fKpamSQOUSmfWJTnry/LiYbspi1OB2x3GQk3/4ANw0S4L83A6oXHUMg8x7/sZw==
        =E71P
        -----END PGP PUBLIC KEY BLOCK-----

packages:
- libpmix-dev
- openmpi-bin
- mysql-server
- jq
- logrotate
- munge
- slurmctld
- slurmdbd
- slurm-client
- slurmd
- mpich
- python3-venv
- apptainer-suid
- influxdb
- influxdb-client

snap:
  commands:
    0: snap install vantage-agent --channel=stable --classic
    1: snap install jobbergate-agent --channel=stable --classic
    2: snap install multipass-sshfs

bootcmd:
- mkdir /run/packer_backup
- mkdir /run/packer_backup/etc
- mkdir /run/packer_backup/etc/apt
- mkdir /run/packer_backup/etc/ssh
- cp --preserve /etc/apt/sources.list /run/packer_backup/etc/apt/
- cp --preserve /etc/ssh/sshd_config /run/packer_backup/etc/ssh/

runcmd:
- sed -i -e '/^[#]*PermitRootLogin/s/^.*$/PermitRootLogin yes/' /etc/ssh/sshd_config
- systemctl restart ssh
# MySQL
- systemctl start mysql.service
- |
  mysql << END

  CREATE USER 'slurm'@'localhost' IDENTIFIED BY 'rats';
  CREATE DATABASE IF NOT EXISTS slurm DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
  GRANT ALL PRIVILEGES ON  slurm.* TO 'slurm'@'localhost';

  END
# InfluxDB
- systemctl start influxdb.service
- influx -execute "CREATE USER slurm WITH PASSWORD 'rats'"
- influx -execute 'CREATE DATABASE "slurm-job-metrics"'
- influx -execute 'GRANT ALL ON "slurm-job-metrics" TO "slurm"'
- influx -execute 'CREATE RETENTION POLICY "three_days" ON "slurm-job-metrics" DURATION 3d REPLICATION 1 DEFAULT'
# Chown slurmdbd.conf
- chown slurm /etc/slurm/slurmdbd.conf
# create mungekey
- dd if=/dev/urandom of=/etc/munge/munge.key bs=1 count=1024
- chown munge:munge /etc/munge/munge.key
- chmod 600 /etc/munge/munge.key
- chown -R munge /etc/munge/ /var/log/munge/
- chmod 0700 /etc/munge/ /var/log/munge/
- systemctl enable munge
- systemctl start munge
# make sure the daemons are running
- systemctl stop slurmdbd
- systemctl stop slurmctld
- systemctl stop slurmd
- mkdir -p /nfs/mnt
- chmod 777 /nfs/mnt
